<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Wall BOQ Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styles for printing */
        @media print {
            body {
                background-color: #fff !important;
                color: #000 !important;
            }

            .no-print {
                display: none !important;
            }

            .boq-section {
                display: block !important;
                box-shadow: none !important;
                border: 1px solid #ccc;
                margin-top: 2rem;
                page-break-inside: avoid;
            }

            .boq-section th,
            .boq-section td {
                color: #000 !important;
                border-color: #ccc !important;
            }

            #grand-total-container {
                justify-content: flex-end;
            }
        }

        /* Make contenteditable cells look like inputs */
        [contenteditable] {
            outline: 2px solid transparent;
            transition: outline-color 0.2s;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        [contenteditable]:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        [contenteditable]:focus {
            outline-color: #3b82f6;
            /* Tailwind's blue-500 */
            background-color: rgba(255, 255, 255, 0.15);
        }

        .boq-table {
            table-layout: fixed;
            width: 100%;
        }

        .boq-table col.item {
            width: 20%;
        }

        .boq-table col.source {
            width: 15%;
        }

        .boq-table col.l,
        .boq-table col.w,
        .boq-table col.h {
            width: 7%;
        }

        .boq-table col.qty {
            width: 8%;
        }

        .boq-table col.unit {
            width: 8%;
        }

        .boq-table col.rate {
            width: 12%;
        }

        .boq-table col.amount {
            width: 16%;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen antialiased flex flex-col items-center p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Retail Wall BOQ Generator</h1>
            <p class="mt-2 text-lg text-gray-400">Select a brand and enter wall dimensions to generate a detailed BOQ.
            </p>
        </header>

        <!-- Input Form -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 no-print">
            <form id="boq-form" class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
                <div>
                    <label for="brand-select" class="block text-sm font-medium text-gray-300 mb-1">Brand</label>
                    <select id="brand-select"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                        <option value="Parx">Parx</option>
                        <option value="Park Avenue">Park Avenue</option>
                        <option value="Ready to Wear">Ready to Wear</option>
                        <option value="ColorPlus">ColorPlus</option>
                        <option value="Ethnix">Ethnix</option>
                    </select>
                </div>
                <div id="rate-type-container" class="hidden">
                    <label for="rate-type-select" class="block text-sm font-medium text-gray-300 mb-1">Rate Type</label>
                    <select id="rate-type-select"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                        <option value="finalRate">Final Rate</option>
                        <option value="ecplRate">ECPL Rate</option>
                    </select>
                </div>
                <div>
                    <label for="wall-width" class="block text-sm font-medium text-gray-300 mb-1">Wall Width (ft)</label>
                    <input type="number" id="wall-width" step="0.01" required placeholder="e.g., 10.5"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                </div>
                <div>
                    <label for="wall-height" class="block text-sm font-medium text-gray-300 mb-1">Wall Height
                        (ft)</label>
                    <input type="number" id="wall-height" step="0.01" required placeholder="e.g., 8"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                    Generate BOQ
                </button>
            </form>
            <p id="error-message" class="text-red-400 text-center mt-4"></p>
        </div>

        <!-- BOQ Output -->
        <div id="boq-output" class="hidden">
            <div id="grand-total-container" class="flex justify-between items-center mb-6">
                <h2 id="boq-title" class="text-2xl sm:text-3xl font-bold">Bill of Quantities</h2>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <span class="text-gray-400 text-sm">BOQ Grand Total</span>
                        <p id="grand-total" class="text-2xl font-bold">₹ 0.00</p>
                    </div>
                    <button id="print-btn"
                        class="no-print bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
                            <path
                                d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zM1 7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1z" />
                        </svg>
                        Print
                    </button>
                </div>
            </div>
            <div id="boq-sections-container">
                <!-- Sections will be generated here -->
            </div>

            <!-- BOM Output -->
            <div id="bom-output" class="hidden mt-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Bill of Materials (BOM)</h2>
                </div>
                <div id="bom-sections-container">
                    <!-- BOM will be generated here -->
                </div>
                <!-- Margin and Final Total Section -->
                <div id="final-calculation-section" class="hidden mt-6 flex justify-end">
                    <div class="w-full max-w-sm bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-400">BOM Total</span>
                            <span id="bom-sub-total-display" class="font-semibold">₹ 0.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <label for="margin-multiplier" class="text-gray-400">Margin Multiplier (x)</label>
                            <span id="margin-multiplier" contenteditable="true"
                                class="bg-gray-700 px-2 py-1 rounded font-semibold text-right w-20">2.20</span>
                        </div>
                        <hr class="border-gray-600 my-2">
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-xl font-bold">Final Total</span>
                            <span id="final-total" class="text-xl font-bold text-green-400">₹ 0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FT_TO_MM = 304.8;
        const MM_TO_FT = 1 / 304.8;
        const SQMM_TO_SQFT = MM_TO_FT * MM_TO_FT;
        const MIN_PORTAL_THICKNESS_MM = 18;
        const BACK_PANEL_MODULE_MM = 600;
        const SHEET_SQFT = 32; // 8ft x 4ft

        // --- PARX RATE CONTRACT DATA ---
        const PARX_RATE_CONTRACT = {
            "SIDE PORTAL": [
                { l: 18, w: 450, h: 1800, finalRate: 2340, ecplRate: 2160 },
                { l: 18, w: 450, h: 2100, finalRate: 2340, ecplRate: 2520 },
                { l: 18, w: 450, h: 2400, finalRate: 2340, ecplRate: 2880 },
                { l: 18, w: 450, h: 2700, finalRate: 2750, ecplRate: 3240 },
                { l: 75, w: 450, h: 1800, finalRate: 6500, ecplRate: 6300 },
                { l: 75, w: 450, h: 2100, finalRate: 6500, ecplRate: 7350 },
                { l: 75, w: 450, h: 2400, finalRate: 6500, ecplRate: 8400 },
                { l: 75, w: 450, h: 2700, finalRate: 7680, ecplRate: 9450 },
                { l: 100, w: 450, h: 1800, finalRate: 6500, ecplRate: 6676 },
                { l: 100, w: 450, h: 2100, finalRate: 6500, ecplRate: 7770 },
                { l: 100, w: 450, h: 2400, finalRate: 6500, ecplRate: 8880 },
                { l: 100, w: 450, h: 2700, finalRate: 7000, ecplRate: 9990 },
                { l: 150, w: 450, h: 1800, finalRate: 6800, ecplRate: 6840 },
                { l: 150, w: 450, h: 2100, finalRate: 6800, ecplRate: 7980 },
                { l: 150, w: 450, h: 2400, finalRate: 6800, ecplRate: 9120 },
                { l: 150, w: 450, h: 2700, finalRate: 7500, ecplRate: 10530 },
                { l: 200, w: 450, h: 1800, finalRate: 7500, ecplRate: 7200 },
                { l: 200, w: 450, h: 2100, finalRate: 7500, ecplRate: 8400 },
                { l: 200, w: 450, h: 2400, finalRate: 7500, ecplRate: 9600 },
                { l: 200, w: 450, h: 2700, finalRate: 8000, ecplRate: 9600 },
                { l: 50, w: 450, h: 1800, finalRate: 2400, ecplRate: 4000 },
                { l: 50, w: 450, h: 2100, finalRate: 2400, ecplRate: 4000 },
                { l: 50, w: 450, h: 2400, finalRate: 2800, ecplRate: 4000 },
                { l: 50, w: 450, h: 2700, finalRate: 2800, ecplRate: 4000 },
            ],
            "BACK PANEL": [
                { l: 600, w: 18, h: 1800, finalRate: 3130, ecplRate: 3240 },
                { l: 600, w: 18, h: 2100, finalRate: 3130, ecplRate: 3780 },
                { l: 600, w: 18, h: 2400, finalRate: 3130, ecplRate: 4320 },
                { l: 600, w: 18, h: 2700, finalRate: 3680, ecplRate: 4860 },
            ],
            "SHELVE": [
                { l: 600, w: 430, h: 18, finalRate: 750, ecplRate: 950 },
                { l: 500, w: 430, h: 18, finalRate: 700, ecplRate: 800 },
            ],
            "DRAWER": [
                { l: 600, w: 430, h: 325, finalRate: 4500, ecplRate: 6489 },
                { l: 500, w: 430, h: 325, finalRate: 4500, ecplRate: 5295 },
            ],
            "HEADER": [
                { l: 1219, w: 450, h: 300, finalRate: 6500, ecplRate: 8010 },
                { l: 1396, w: 450, h: 300, finalRate: 7500, ecplRate: 12275 },
                { l: 1800, w: 450, h: 300, finalRate: 9500, ecplRate: 14508 },
                { l: 2100, w: 450, h: 300, finalRate: 12100, ecplRate: 22470 },
                { l: 2400, w: 450, h: 300, finalRate: 13500, ecplRate: 25680 },
                { l: 3000, w: 450, h: 300, finalRate: 17500, ecplRate: 3210 },
                { l: 4000, w: 450, h: 300, finalRate: 22500, ecplRate: 40280 },
                { l: 4500, w: 450, h: 300, finalRate: 25500, ecplRate: 45315 },
                { l: 5000, w: 450, h: 300, finalRate: 28500, ecplRate: 50350 },
                { l: 5000, w: 450, h: 300, finalRate: 31500, ecplRate: 55385 },
            ],
            "CHANNEL": [
                { l: 40, w: 25, h: 1800, finalRate: 850, ecplRate: 1440 },
                { l: 40, w: 25, h: 2100, finalRate: 850, ecplRate: 1470 },
                { l: 40, w: 25, h: 2400, finalRate: 850, ecplRate: 1550 },
            ],
            "PLINTH": [
                { l: 600, w: 50, h: 50, finalRate: 1000, ecplRate: 2150 },
                { l: 500, w: 50, h: 50, finalRate: 1000, ecplRate: 1791 },
            ],
            "STRAIGHT ARM": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 497 },
            ],
            "BACKBAR": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 597 },
            ],
            "SHELF BRACKET": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 380 },
            ],
        };

        function findClosestRate(itemKey, l, w, h, rateType) {
            const rateList = PARX_RATE_CONTRACT[itemKey.toUpperCase().replace(/S$/, '').replace(/_/, ' ')];
            if (!rateList) return { rate: 0, source: null };

            let closestMatch = null;
            let minDiff = Infinity;

            rateList.forEach(rateItem => {
                // A simple difference sum for matching. Accessories without dimensions will have 0 diff and match first entry.
                const diff = Math.abs(rateItem.l - l) + Math.abs(rateItem.w - w) + Math.abs(rateItem.h - h);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestMatch = rateItem;
                }
            });

            if (closestMatch) {
                return {
                    rate: closestMatch[rateType],
                    source: closestMatch
                };
            }
            return { rate: 0, source: null };
        }


        // --- BRAND-SPECIFIC FIXTURE CONFIGURATION ---
        const BRAND_DATA = {
            "Parx": {
                getRate: findClosestRate, // Assign the lookup function
                wallFixtures: [
                    { item: "Header", unit: "Nos", rate: 0, qty: () => 1, l: (w, h, config) => config.wallWidthInMM, w: () => 450, h: () => 300 },
                    { item: "Side Portals", unit: "Nos", rate: 0, qty: () => 2, l: (w, h, config) => config.adjustedPortalThickness, w: () => 450, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Back Panels", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 18, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Channels", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays + 1, l: () => 40, w: () => 25, h: (w, h) => (h * FT_TO_MM) - 300 },
                    {
                        item: "Shelves", unit: "Nos", rate: 0, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50 + 325; // plinth + drawer
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300; // total - header - bottom - top_clearance
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 600, w: () => 430, h: () => 18
                    },
                    { item: "Drawers", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => 600, w: () => 430, h: () => 325 },
                    { item: "Plinth", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 50, h: () => 50 },
                    { item: "Signage", unit: "SqFt", rate: 3650, qty: () => (600 * 300) * SQMM_TO_SQFT, l: () => 600, w: () => 30, h: () => 300 }
                ],
                accessories: [
                    { item: "Straight Arm", unit: "Nos", rate: 0, qty: (w) => Math.floor(w * 2), l: () => 25, w: () => 300, h: () => 25 },
                    { item: "Backbar", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays * 2, l: () => 580, w: () => 25, h: () => 25 },
                    {
                        item: "Shelf Bracket", unit: "Nos", rate: 0, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50 + 325; // plinth + drawer
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays; // One bracket per shelf
                        }, l: () => 0, w: () => 0, h: () => 0
                    },
                ]
            },
            "Park Avenue": {
                wallFixtures: [
                    { item: "Header", unit: "Nos", rate: 6500, qty: () => 1, l: (w, h, config) => config.wallWidthInMM, w: () => 450, h: () => 300 },
                    { item: "Side Portals", unit: "Nos", rate: 4500, qty: () => 2, l: (w, h, config) => config.adjustedPortalThickness, w: () => 450, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Back Panels", unit: "Nos", rate: 4000, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 18, h: (w, h) => (h * FT_TO_MM) - 300 },
                    {
                        item: "Shelves", unit: "Nos", rate: 1200, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50 + 300; // plinth + drawer
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 580, w: () => 430, h: () => 8
                    },
                    { item: "Drawers", unit: "Nos", rate: 3800, qty: (w, h, config) => config.numBays, l: () => 580, w: () => 430, h: () => 300 },
                    { item: "Plinth", unit: "Nos", rate: 900, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 50, h: () => 50 },
                    { item: "Signage", unit: "Nos", rate: 9000, qty: () => 1, l: () => 750, w: () => 50, h: () => 350 },
                ],
                accessories: [
                    { item: "Side Hanging Bar", unit: "Nos", rate: 950, qty: (w) => Math.floor(w / 5) * 2, l: () => 400, w: () => 25, h: () => 50 },
                    {
                        item: "Shelf Bracket", unit: "Nos", rate: 250, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50 + 300;
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 0, w: () => 0, h: () => 0
                    },
                ]
            },
            "ColorPlus": {
                wallFixtures: [
                    { item: "Header", unit: "Nos", rate: 5800, qty: () => 1, l: (w, h, config) => config.wallWidthInMM, w: () => 450, h: () => 300 },
                    { item: "Side Portals", unit: "Nos", rate: 3200, qty: () => 2, l: (w, h, config) => config.adjustedPortalThickness, w: () => 450, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Back Panels", unit: "Nos", rate: 3500, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 18, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Channels", unit: "Nos", rate: 1400, qty: (w, h, config) => config.numBays + 1, l: () => 25, w: () => 25, h: (w, h) => (h * FT_TO_MM) - 300 },
                    {
                        item: "Shelves", unit: "Nos", rate: 1500, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50; // just plinth
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 580, w: () => 430, h: () => 25
                    },
                    { item: "Drawers", unit: "Nos", rate: 4200, qty: () => 0, l: () => 580, w: () => 430, h: () => 300 },
                    { item: "Plinth", unit: "Nos", rate: 1000, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 50, h: () => 50 },
                    { item: "Signage", unit: "Nos", rate: 7500, qty: () => 1, l: () => 800, w: () => 10, h: () => 250 },
                ],
                accessories: [
                    { item: "Straight Arm", unit: "Nos", rate: 450, qty: (w) => Math.floor(w * 1.5), l: () => 50, w: () => 300, h: () => 25 },
                    {
                        item: "Shelf Bracket", unit: "Nos", rate: 250, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50;
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 0, w: () => 0, h: () => 0
                    },
                ]
            },
            "Ethnix": {
                wallFixtures: [
                    { item: "Header", unit: "Nos", rate: 7000, qty: () => 1, l: (w, h, config) => config.wallWidthInMM, w: () => 450, h: () => 300 },
                    { item: "Side Portals", unit: "Nos", rate: 5000, qty: () => 2, l: (w, h, config) => config.adjustedPortalThickness, w: () => 450, h: (w, h) => (h * FT_TO_MM) - 300 },
                    { item: "Back Panels", unit: "Nos", rate: 4500, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 18, h: (w, h) => (h * FT_TO_MM) - 300 },
                    {
                        item: "Shelves", unit: "Nos", rate: 1800, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50; // just plinth
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 580, w: () => 430, h: () => 12
                    },
                    { item: "Drawers", unit: "Nos", rate: 4800, qty: () => 0, l: () => 580, w: () => 430, h: () => 300 },
                    { item: "Plinth", unit: "Nos", rate: 1200, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 50, h: () => 50 },
                    { item: "Signage", unit: "Nos", rate: 8500, qty: () => 1, l: () => 900, w: () => 25, h: () => 300 }
                ],
                accessories: [
                    { item: "Side Hanging Bar", unit: "Nos", rate: 1200, qty: (w, h, config) => config.numBays, l: () => 580, w: () => 25, h: () => 50 },
                    { item: "Waterfall Arm", unit: "Nos", rate: 600, qty: (w) => Math.floor(w), l: () => 50, w: () => 400, h: () => 50 },
                    {
                        item: "Shelf Bracket", unit: "Nos", rate: 250, qty: (w, h, config) => {
                            const totalHeightMM = h * FT_TO_MM;
                            const bottomClearance = 50;
                            const availableHeight = totalHeightMM - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 0, w: () => 0, h: () => 0
                    },
                ]
            }
        };
        // Use Parx as default for "Ready to Wear"
        BRAND_DATA["Ready to Wear"] = BRAND_DATA["Parx"];

        const BOM_DATA = {
            "Parx": {
                materials: [
                    {
                        item: "18mm MDF OSL (Off-white)", unit: "Sheets (8x4 ft)", rate: 2080, // 65/sqft * 32 sqft
                        getQtyAndBreakdown: (fixtures) => {
                            let totalArea = 0;
                            const breakdown = {};
                            const process = (f, name) => {
                                const surfaceArea = (2 * (f.l * f.w + f.l * f.h + f.w * f.h)) * f.qty;
                                if (surfaceArea > 0) {
                                    totalArea += surfaceArea;
                                    breakdown[name] = { value: surfaceArea * SQMM_TO_SQFT, unit: 'SqFt' };
                                }
                            };
                            (fixtures.Header || []).forEach(f => process(f, 'Header'));
                            (fixtures.Side_Portals || []).forEach(f => process(f, 'Side Portals'));
                            (fixtures.Plinth || []).forEach(f => process(f, 'Plinth'));

                            if (fixtures.Drawers) {
                                fixtures.Drawers.forEach(drawer => {
                                    const drawerArea = ((drawer.l * drawer.w) + (drawer.l * drawer.h)) * drawer.qty;
                                    if (drawerArea > 0) {
                                        totalArea += drawerArea;
                                        breakdown['Drawers'] = { value: drawerArea * SQMM_TO_SQFT, unit: 'SqFt' };
                                    }
                                });
                            }

                            return { total: Math.ceil((totalArea * SQMM_TO_SQFT) / SHEET_SQFT), breakdown };
                        }
                    },
                    {
                        item: "18mm MDF BSL (Off-white)", unit: "Sheets (8x4 ft)", rate: 2400, // 75/sqft * 32 sqft
                        getQtyAndBreakdown: (fixtures) => {
                            let totalArea = 0;
                            const breakdown = {};

                            if (fixtures.Back_Panels) {
                                fixtures.Back_Panels.forEach(f => {
                                    const area = (f.l * f.h) * f.qty;
                                    totalArea += area;
                                    breakdown['Back Panels'] = { value: area * SQMM_TO_SQFT, unit: 'SqFt' };
                                });
                            }
                            if (fixtures.Drawers) {
                                fixtures.Drawers.forEach(drawer => {
                                    const area = ((2 * drawer.w * drawer.h) + (drawer.l * drawer.h)) * drawer.qty;
                                    totalArea += area;
                                    breakdown['Drawers'] = { value: area * SQMM_TO_SQFT, unit: 'SqFt' };
                                });
                            }
                            if (fixtures.Shelves) {
                                fixtures.Shelves.forEach(f => {
                                    const area = (f.l * f.w) * f.qty;
                                    totalArea += area;
                                    breakdown['Shelves'] = { value: area * SQMM_TO_SQFT, unit: 'SqFt' };
                                });
                            }
                            return { total: Math.ceil((totalArea * SQMM_TO_SQFT) / SHEET_SQFT), breakdown };
                        }
                    },
                    {
                        item: "Light Blue Laminate (1mm)", unit: "Sheets (8x4 ft)", rate: 1504, // 47/sqft * 32 sqft
                        getQtyAndBreakdown: (fixtures) => {
                            let totalArea = 0;
                            const breakdown = {};
                            const process = (f, name) => {
                                const surfaceArea = (2 * (f.l * f.w + f.l * f.h + f.w * f.h)) * f.qty;
                                if (surfaceArea > 0) {
                                    totalArea += surfaceArea;
                                    breakdown[name] = { value: surfaceArea * SQMM_TO_SQFT, unit: 'SqFt' };
                                }
                            };
                            (fixtures.Header || []).forEach(f => process(f, 'Header'));
                            (fixtures.Side_Portals || []).forEach(f => process(f, 'Side Portals'));
                            (fixtures.Plinth || []).forEach(f => process(f, 'Plinth'));

                            if (fixtures.Drawers) {
                                fixtures.Drawers.forEach(drawer => {
                                    const drawerArea = ((drawer.l * drawer.w) + (drawer.l * drawer.h)) * drawer.qty;
                                    if (drawerArea > 0) {
                                        totalArea += drawerArea;
                                        breakdown['Drawers'] = { value: drawerArea * SQMM_TO_SQFT, unit: 'SqFt' };
                                    }
                                });
                            }
                            return { total: Math.ceil((totalArea * SQMM_TO_SQFT) / SHEET_SQFT), breakdown };
                        }
                    },
                    {
                        item: "25x25mm MDF Strips", unit: "RFt", rate: 8.3,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalLength = 0;
                            const breakdown = {};
                            const items = (fixtures.Header || []).concat(fixtures.Side_Portals || []);
                            items.forEach(f => {
                                if (!f || f.l < 50) return;
                                const numStrips = Math.ceil(f.h / 50.4);
                                const length = (numStrips * f.l) * f.qty;
                                totalLength += length;
                                breakdown[f.item] = { value: length * MM_TO_FT, unit: 'RFt' };
                            });
                            return { total: totalLength * MM_TO_FT, breakdown };
                        }
                    },
                    {
                        item: "Duco Paint (for strips)", unit: "SqFt", rate: 200,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalArea = 0;
                            const breakdown = {};
                            const items = (fixtures.Header || []).concat(fixtures.Side_Portals || []);
                            items.forEach(f => {
                                if (!f || f.l < 50) return;
                                const frontArea = (f.l * f.h * 1.5) * f.qty;
                                totalArea += frontArea;
                                breakdown[f.item] = { value: frontArea * SQMM_TO_SQFT, unit: 'SqFt' };
                            });
                            return { total: totalArea * SQMM_TO_SQFT, breakdown };
                        }
                    },
                    {
                        item: "PVC Edge Banding (25mm)", unit: "RFt", rate: 7,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalLength = 0;
                            const breakdown = {};
                            const mdfItems = (fixtures.Header || []).concat(fixtures.Side_Portals || [], fixtures.Plinth || [], fixtures.Shelves || [], fixtures.Drawers || []);
                            mdfItems.forEach(f => {
                                const perimeter = (2 * (f.l + f.w)) * f.qty;
                                totalLength += perimeter;
                                breakdown[f.item] = (breakdown[f.item] || 0) + perimeter;
                            });
                            Object.keys(breakdown).forEach(key => breakdown[key] = { value: breakdown[key] * MM_TO_FT, unit: 'RFt' });
                            return { total: totalLength * MM_TO_FT, breakdown };
                        }
                    },
                    {
                        item: "Aluminium Channel Profile", unit: "RFt", rate: 115,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalLength = 0;
                            const breakdown = {};
                            if (fixtures.Channels) {
                                fixtures.Channels.forEach(f => {
                                    const length = f.h * f.qty;
                                    totalLength += length;
                                    breakdown[f.item] = { value: length * MM_TO_FT, unit: 'RFt' };
                                });
                            }
                            return { total: totalLength * MM_TO_FT, breakdown };
                        }
                    },
                    {
                        item: "Backclips for Accessories", unit: "Nos", rate: 40,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalClips = 0;
                            const breakdown = {};
                            const items = (fixtures.Straight_Arm || []).concat(fixtures.Backbar || []);
                            items.forEach(f => {
                                const clips = f.qty * 2;
                                totalClips += clips;
                                breakdown[f.item] = { value: clips, unit: 'Nos' };
                            });
                            return { total: totalClips, breakdown };
                        }
                    },
                    {
                        item: "MS Pipe (25x40mm, 1.5mm thk)", unit: "Kg", rate: 110,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalLengthFT = 0;
                            const breakdown = {};
                            const weightPerFoot = 0.45;
                            if (fixtures.Straight_Arm) {
                                fixtures.Straight_Arm.forEach(f => {
                                    const len = f.w * MM_TO_FT * f.qty;
                                    totalLengthFT += len;
                                    breakdown[f.item] = { value: len * weightPerFoot, unit: 'Kg' };
                                });
                            }
                            if (fixtures.Backbar) {
                                fixtures.Backbar.forEach(f => {
                                    const len = f.l * MM_TO_FT * f.qty;
                                    totalLengthFT += len;
                                    breakdown[f.item] = { value: len * weightPerFoot, unit: 'Kg' };
                                });
                            }
                            return { total: totalLengthFT * weightPerFoot, breakdown };
                        }
                    },
                    {
                        item: "Powder Coating", unit: "Lump Sum", rate: 1,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalCost = 0;
                            const breakdown = {};
                            const rftRate = 25;
                            const sqftRate = 50;

                            if (fixtures.Channels) {
                                let qtySqFt = 0;
                                fixtures.Channels.forEach(c => {
                                    qtySqFt += ((2 * (c.l + c.w) * c.h) * SQMM_TO_SQFT) * c.qty;
                                });
                                if (qtySqFt > 0) {
                                    breakdown['Channels'] = { value: qtySqFt, unit: 'SqFt' };
                                    totalCost += qtySqFt * sqftRate;
                                }
                            }
                            if (fixtures.Backbar) {
                                let qtyRft = 0;
                                fixtures.Backbar.forEach(b => qtyRft += (b.l * MM_TO_FT * b.qty));
                                if (qtyRft > 0) {
                                    breakdown['Backbar'] = { value: qtyRft, unit: 'RFt' };
                                    totalCost += qtyRft * rftRate;
                                }
                            }
                            if (fixtures.Shelf_Bracket) {
                                let qtyRft = 0;
                                fixtures.Shelf_Bracket.forEach(sb => qtyRft += (sb.qty * 350 * MM_TO_FT));
                                if (qtyRft > 0) {
                                    breakdown['Shelf Bracket'] = { value: qtyRft, unit: 'RFt' };
                                    totalCost += qtyRft * rftRate;
                                }
                            }

                            return { total: totalCost, breakdown };
                        }
                    },
                    {
                        item: "Finished 3D Acrylic Signage", unit: "SqFt", rate: 3650,
                        getQtyAndBreakdown: (fixtures) => {
                            let totalQty = 0;
                            const breakdown = {};
                            if (fixtures.Signage) {
                                fixtures.Signage.forEach(f => {
                                    totalQty += f.qty;
                                    breakdown[f.item] = { value: f.qty, unit: 'SqFt' };
                                });
                            }
                            return { total: totalQty, breakdown };
                        }
                    }
                ]
            }
        }


        // --- DOM ELEMENTS ---
        const form = document.getElementById('boq-form');
        const brandSelect = document.getElementById('brand-select');
        const rateTypeContainer = document.getElementById('rate-type-container');
        const rateTypeSelect = document.getElementById('rate-type-select');
        const widthInput = document.getElementById('wall-width');
        const heightInput = document.getElementById('wall-height');
        const errorMessage = document.getElementById('error-message');
        const boqOutput = document.getElementById('boq-output');
        const boqTitle = document.getElementById('boq-title');
        const sectionsContainer = document.getElementById('boq-sections-container');
        const grandTotalCell = document.getElementById('grand-total');
        const printBtn = document.getElementById('print-btn');
        const bomOutput = document.getElementById('bom-output');
        const bomContainer = document.getElementById('bom-sections-container');
        const finalCalculationSection = document.getElementById('final-calculation-section');
        const bomSubTotalDisplay = document.getElementById('bom-sub-total-display');
        const marginMultiplier = document.getElementById('margin-multiplier');
        const finalTotalCell = document.getElementById('final-total');


        // --- EVENT LISTENERS ---
        form.addEventListener('submit', handleFormSubmit);
        printBtn.addEventListener('click', () => window.print());
        sectionsContainer.addEventListener('input', handleBoqCellChange);
        bomContainer.addEventListener('input', handleBomCellChange);
        marginMultiplier.addEventListener('input', updateFinalTotal);
        brandSelect.addEventListener('change', toggleRateTypeSelector);

        // --- FUNCTIONS ---
        function toggleRateTypeSelector() {
            if (brandSelect.value === 'Parx' || brandSelect.value === 'Ready to Wear') {
                rateTypeContainer.classList.remove('hidden');
            } else {
                rateTypeContainer.classList.add('hidden');
            }
        }
        toggleRateTypeSelector(); // Initial check

        function calculateWallConfig(wallWidthInFeet) {
            const wallWidthInMM = wallWidthInFeet * FT_TO_MM;

            const internalSpaceGuess = wallWidthInMM - (2 * MIN_PORTAL_THICKNESS_MM);
            let numBays = Math.round(internalSpaceGuess / BACK_PANEL_MODULE_MM);
            if (numBays < 1) {
                numBays = 1;
            }

            const totalModuleWidth = numBays * BACK_PANEL_MODULE_MM;
            const remainingWidthForPortals = wallWidthInMM - totalModuleWidth;
            let adjustedPortalThickness = remainingWidthForPortals / 2;

            if (adjustedPortalThickness < MIN_PORTAL_THICKNESS_MM) {
                if (numBays > 1) {
                    numBays--;
                    const newTotalModuleWidth = numBays * BACK_PANEL_MODULE_MM;
                    const newRemainingWidth = wallWidthInMM - newTotalModuleWidth;
                    adjustedPortalThickness = newRemainingWidth / 2;
                }
            }

            return {
                numBays,
                adjustedPortalThickness,
                wallWidthInMM
            };
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const width = parseFloat(widthInput.value);
            const height = parseFloat(heightInput.value);
            const brand = brandSelect.value;

            if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                errorMessage.textContent = 'Please enter valid, positive numbers for width and height.';
                boqOutput.classList.add('hidden');
                bomOutput.classList.add('hidden');
                finalCalculationSection.classList.add('hidden');
                return;
            }
            errorMessage.textContent = '';
            generateAndDisplayBOQ(width, height, brand);
        }

        function generateAndDisplayBOQ(width, height, brand) {
            sectionsContainer.innerHTML = ''; // Clear previous results
            bomContainer.innerHTML = '';
            bomOutput.classList.add('hidden');
            finalCalculationSection.classList.add('hidden');

            const data = BRAND_DATA[brand];
            if (!data) return;

            const wallConfig = calculateWallConfig(width);

            boqTitle.textContent = `BOQ for ${brand} Wall (${width}' x ${height}')`;

            let generatedFixtures = {};

            const sectionMappings = {
                'Wall Fixtures': data.wallFixtures,
                'Accessories': data.accessories
            };

            const rateType = rateTypeSelect.value;

            for (const [title, items] of Object.entries(sectionMappings)) {
                if (items && items.length > 0) {
                    const { sectionHTML, fixtures } = createSectionHTML(title, items, width, height, wallConfig, data.getRate, rateType);
                    if (sectionHTML) {
                        sectionsContainer.insertAdjacentHTML('beforeend', sectionHTML);
                        // Merge fixtures into the main object
                        Object.keys(fixtures).forEach(key => {
                            if (!generatedFixtures[key]) {
                                generatedFixtures[key] = [];
                            }
                            generatedFixtures[key] = generatedFixtures[key].concat(fixtures[key]);
                        });
                    }
                }
            }

            updateTotals();
            boqOutput.classList.remove('hidden');

            if (BOM_DATA[brand]) {
                const currentFixtures = getFixturesFromBOQTable();
                generateAndDisplayBOM(brand, currentFixtures);
            }
        }

        function createSectionHTML(title, items, width, height, wallConfig, getRateFn, rateType) {
            let rowsHTML = '';
            const sectionFixtures = {};
            let sectionTotal = 0;

            items.forEach(item => {
                const qty = item.qty(width, height, wallConfig);
                if (qty <= 0) return;

                const l = item.l(width, height, wallConfig);
                const w = item.w(width, height, wallConfig);
                const h = item.h(width, height, wallConfig);

                let rate = item.rate;
                let sourceDimText = 'N/A';

                if (getRateFn) {
                    const itemKey = item.item.replace(/\s+/g, '_');
                    const result = getRateFn(itemKey, l, w, h, rateType);
                    if (result && result.source) {
                        rate = result.rate;
                        sourceDimText = (result.source.l === 0 && result.source.w === 0 && result.source.h === 0)
                            ? 'Standard'
                            : `${result.source.l}x${result.source.w}x${result.source.h}`;
                    }
                }

                const itemKey = item.item.replace(/\s+/g, '_');
                if (!sectionFixtures[itemKey]) sectionFixtures[itemKey] = [];
                sectionFixtures[itemKey].push({ item: item.item, qty, l, w, h });

                const amount = qty * rate;
                sectionTotal += amount;

                rowsHTML += `
                <tr class="border-b border-gray-700" data-item-key="${itemKey}">
                    <td class="p-3" data-label="item">${item.item}</td>
                    <td class="p-3 text-gray-400">${sourceDimText}</td>
                    <td class="p-3 text-right" data-label="l">${Math.round(l)}</td>
                    <td class="p-3 text-right" data-label="w">${Math.round(w)}</td>
                    <td class="p-3 text-right" data-label="h">${Math.round(h)}</td>
                    <td class="p-3 text-right" contenteditable="true" data-qty>${qty.toFixed(2)}</td>
                    <td class="p-3">${item.unit}</td>
                    <td class="p-3 text-right" contenteditable="true" data-rate>${rate.toFixed(2)}</td>
                    <td class="p-3 text-right font-medium" data-amount>₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `;
            });

            if (!rowsHTML) {
                return { sectionHTML: '', fixtures: {} };
            }

            const sectionHTML = `
            <div class="boq-section mb-8">
                <h3 class="text-xl font-bold bg-gray-700 p-3 rounded-t-lg">${title}</h3>
                <div class="overflow-x-auto bg-gray-800 rounded-b-lg">
                    <table class="boq-table">
                        <colgroup>
                           <col class="item"><col class="source">
                           <col class="l"><col class="w"><col class="h">
                           <col class="qty"><col class="unit"><col class="rate"><col class="amount">
                        </colgroup>
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="p-3 text-left font-semibold">Item</th>
                                <th class="p-3 text-left font-semibold">Source Dim. (LWH)</th>
                                <th class="p-3 text-right font-semibold">L(mm)</th>
                                <th class="p-3 text-right font-semibold">W(mm)</th>
                                <th class="p-3 text-right font-semibold">H(mm)</th>
                                <th class="p-3 text-right font-semibold">Quantity</th>
                                <th class="p-3 text-left font-semibold">Unit</th>
                                <th class="p-3 text-right font-semibold">Rate (₹)</th>
                                <th class="p-3 text-right font-semibold">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHTML}</tbody>
                        <tfoot>
                            <tr class="border-t-2 border-gray-600 bg-gray-700/50">
                                <td colspan="8" class="p-3 text-right font-bold text-lg">Section Total</td>
                                <td class="p-3 text-right font-bold text-lg" data-section-total>₹ ${sectionTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
            return { sectionHTML, fixtures: sectionFixtures };
        }

        function getFixturesFromBOQTable() {
            const fixtures = {};
            const rows = sectionsContainer.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const itemKey = row.dataset.itemKey;
                if (!itemKey) return;

                if (!fixtures[itemKey]) {
                    fixtures[itemKey] = [];
                }

                fixtures[itemKey].push({
                    item: row.querySelector('[data-label="item"]').textContent,
                    l: parseFloat(row.querySelector('[data-label="l"]').textContent) || 0,
                    w: parseFloat(row.querySelector('[data-label="w"]').textContent) || 0,
                    h: parseFloat(row.querySelector('[data-label="h"]').textContent) || 0,
                    qty: parseFloat(row.querySelector('[data-qty]').textContent) || 0,
                });
            });
            return fixtures;
        }


        function generateAndDisplayBOM(brand, fixtures) {
            const bomData = BOM_DATA[brand];
            if (!bomData) return;

            const bomHTML = createBomSectionHTML("Raw Materials", bomData.materials, fixtures);
            bomContainer.innerHTML = bomHTML;
            bomOutput.classList.remove('hidden');
            finalCalculationSection.classList.remove('hidden');
            updateBomTotal();
        }

        function createBomSectionHTML(title, materials, fixtures) {
            let rowsHTML = '';
            materials.forEach(mat => {
                const { total, breakdown } = mat.getQtyAndBreakdown(fixtures);
                if (total <= 0 && Object.keys(breakdown).length === 0) return;
                const amount = total * mat.rate;

                let breakdownText = '';
                const breakdownParts = [];
                for (const [key, data] of Object.entries(breakdown)) {
                    if (data && typeof data.value !== 'undefined' && data.unit) {
                        breakdownParts.push(`${key}: ${data.value.toFixed(2)} ${data.unit}`);
                    }
                }
                if (breakdownParts.length > 0) {
                    breakdownText = `(${breakdownParts.join(', ')})`;
                }


                rowsHTML += `
                <tr class="border-b border-gray-700">
                    <td class="p-3 align-top">
                        <div>${mat.item}</div>
                        <div class="text-xs text-gray-400 mt-1">${breakdownText}</div>
                    </td>
                    <td class="p-3 text-right" contenteditable="true" data-bom-qty>${total.toFixed(2)}</td>
                    <td class="p-3 text-center">${mat.unit}</td>
                    <td class="p-3 text-right" contenteditable="true" data-bom-rate>${mat.rate.toFixed(2)}</td>
                    <td class="p-3 text-right font-medium" data-bom-amount>₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `;
            });

            return `
            <div class="boq-section mb-8">
                <h3 class="text-xl font-bold bg-gray-700 p-3 rounded-t-lg">${title}</h3>
                <div class="overflow-x-auto bg-gray-800 rounded-b-lg">
                    <table class="w-full">
                         <thead>
                            <tr class="border-b border-gray-600">
                                <th class="p-3 text-left font-semibold w-2/5">Item</th>
                                <th class="p-3 text-right font-semibold">Quantity</th>
                                <th class="p-3 text-center font-semibold">Unit</th>
                                <th class="p-3 text-right font-semibold">Rate (₹)</th>
                                <th class="p-3 text-right font-semibold">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHTML}</tbody>
                        <tfoot>
                            <tr class="border-t-2 border-gray-600 bg-gray-700">
                                <td colspan="4" class="p-3 text-right font-bold">BOM Sub-Total</td>
                                <td id="bom-sub-total-cell" class="p-3 text-right font-bold">₹ 0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
        }

        function updateSectionTotal(sectionEl) {
            if (!sectionEl) return;
            let currentSectionTotal = 0;
            const amountsInSection = sectionEl.querySelectorAll('tbody [data-amount]');
            amountsInSection.forEach(cell => {
                currentSectionTotal += parseFloat(cell.textContent.replace(/[₹,]/g, '')) || 0;
            });
            const totalCell = sectionEl.querySelector('[data-section-total]');
            if (totalCell) {
                totalCell.textContent = `₹ ${currentSectionTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        }

        function handleBoqCellChange(event) {
            const target = event.target;
            if (target.hasAttribute('data-rate') || target.hasAttribute('data-qty')) {
                const row = target.closest('tr');
                if (row) {
                    updateRowAmount(row, '[data-qty]', '[data-rate]', '[data-amount]');
                    updateSectionTotal(row.closest('.boq-section'));
                    updateTotals(); // Recalculates grand total
                    const brand = brandSelect.value;
                    if (BOM_DATA[brand]) {
                        const currentFixtures = getFixturesFromBOQTable();
                        generateAndDisplayBOM(brand, currentFixtures);
                    }
                }
            }
        }

        function handleBomCellChange(event) {
            const target = event.target;
            if (target.hasAttribute('data-bom-rate') || target.hasAttribute('data-bom-qty')) {
                const row = target.closest('tr');
                if (row) {
                    updateRowAmount(row, '[data-bom-qty]', '[data-bom-rate]', '[data-bom-amount]');
                    updateBomTotal();
                }
            }
        }

        function updateRowAmount(row, qtySelector, rateSelector, amountSelector) {
            const qtyCell = row.querySelector(qtySelector);
            const rateCell = row.querySelector(rateSelector);
            const amountCell = row.querySelector(amountSelector);

            const qty = parseFloat(qtyCell.textContent) || 0;
            const rate = parseFloat(rateCell.textContent) || 0;

            const amount = qty * rate;
            amountCell.textContent = `₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function updateTotals() {
            let grandTotal = 0;
            const amountCells = sectionsContainer.querySelectorAll('tbody [data-amount]');

            amountCells.forEach(cell => {
                const amount = parseFloat(cell.textContent.replace(/[₹,]/g, '')) || 0;
                grandTotal += amount;
            });

            grandTotalCell.textContent = `₹ ${grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function updateBomTotal() {
            let bomTotal = 0;
            const amountCells = bomContainer.querySelectorAll('[data-bom-amount]');

            amountCells.forEach(cell => {
                const amount = parseFloat(cell.textContent.replace(/[₹,]/g, '')) || 0;
                bomTotal += amount;
            });

            const formattedTotal = `₹ ${bomTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const subTotalCell = bomContainer.querySelector('#bom-sub-total-cell');
            if (subTotalCell) {
                subTotalCell.textContent = formattedTotal;
            }

            bomSubTotalDisplay.textContent = formattedTotal;
            updateFinalTotal();
        }

        function updateFinalTotal() {
            const bomSubTotalText = bomSubTotalDisplay.textContent || '0';
            const bomSubTotal = parseFloat(bomSubTotalText.replace(/[₹,]/g, '')) || 0;

            const multiplier = parseFloat(marginMultiplier.textContent) || 0;

            const finalTotal = bomSubTotal * multiplier;
            finalTotalCell.textContent = `₹ ${finalTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    </script>
</body>

</html>