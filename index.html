<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Wall BOQ Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styles for printing */
        @media print {
            body {
                background-color: #fff !important;
                color: #000 !important;
            }

            .no-print {
                display: none !important;
            }

            .boq-section {
                display: block !important;
                box-shadow: none !important;
                border: 1px solid #ccc;
                margin-top: 2rem;
                page-break-inside: avoid;
            }

            .boq-section th,
            .boq-section td {
                color: #000 !important;
                border-color: #ccc !important;
            }

            #grand-total-container {
                justify-content: flex-end;
            }
        }

        /* Make contenteditable cells look like inputs */
        [contenteditable] {
            outline: 2px solid transparent;
            transition: outline-color 0.2s;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        [contenteditable]:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        [contenteditable]:focus {
            outline-color: #3b82f6;
            /* Tailwind's blue-500 */
            background-color: rgba(255, 255, 255, 0.15);
        }

        .boq-table {
            table-layout: fixed;
            width: 100%;
        }

        .boq-table col.item {
            width: 20%;
        }

        .boq-table col.source {
            width: 15%;
        }

        .boq-table col.l,
        .boq-table col.w,
        .boq-table col.h {
            width: 7%;
        }

        .boq-table col.qty {
            width: 8%;
        }

        .boq-table col.unit {
            width: 8%;
        }

        .boq-table col.rate {
            width: 12%;
        }

        .boq-table col.amount {
            width: 16%;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen antialiased flex flex-col items-center p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Retail Wall BOQ Generator</h1>
            <p class="mt-2 text-lg text-gray-400">Select a brand and enter wall dimensions to generate a detailed BOQ.
            </p>
        </header>

        <!-- Input Form -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 no-print">
            <form id="boq-form" class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
                <div>
                    <label for="brand-select" class="block text-sm font-medium text-gray-300 mb-1">Brand</label>
                    <select id="brand-select"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                        <option value="Parx">Parx</option>
                        <option value="Park Avenue">Park Avenue</option>
                        <option value="Ready to Wear">Ready to Wear</option>
                        <option value="ColorPlus">ColorPlus</option>
                        <option value="Ethnix">Ethnix</option>
                    </select>
                </div>
                <div id="rate-type-container" class="hidden">
                    <label for="rate-type-select" class="block text-sm font-medium text-gray-300 mb-1">Rate Type</label>
                    <select id="rate-type-select"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                        <option value="finalRate">Final Rate</option>
                        <option value="ecplRate">ECPL Rate</option>
                    </select>
                </div>
                <div>
                    <label for="wall-width" class="block text-sm font-medium text-gray-300 mb-1">Wall Width (mm)</label>
                    <input type="number" id="wall-width" step="1" required placeholder="e.g., 3200"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                </div>
                <div>
                    <label for="wall-height" class="block text-sm font-medium text-gray-300 mb-1">Wall Height
                        (mm)</label>
                    <input type="number" id="wall-height" step="1" required placeholder="e.g., 2400"
                        class="w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                    Generate BOQ
                </button>
            </form>
            <p id="error-message" class="text-red-400 text-center mt-4"></p>
        </div>

        <!-- BOQ Output -->
        <div id="boq-output" class="hidden">
            <div id="grand-total-container" class="flex justify-between items-center mb-6">
                <h2 id="boq-title" class="text-2xl sm:text-3xl font-bold">Bill of Quantities</h2>
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <span class="text-gray-400 text-sm">BOQ Grand Total</span>
                        <p id="grand-total" class="text-2xl font-bold">₹ 0.00</p>
                    </div>
                    <button id="print-btn"
                        class="no-print bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
                            <path
                                d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zM1 7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1z" />
                        </svg>
                        Print
                    </button>
                </div>
            </div>
            <div id="boq-sections-container">
                <!-- Sections will be generated here -->
            </div>


            <!-- Item-wise BOM Output -->
            <div id="item-wise-bom-output" class="hidden mt-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Item-wise Bill of Materials (Unit Recipes)</h2>
                </div>
                <div id="item-wise-bom-container">
                    <!-- Item-wise BOM will be generated here -->
                </div>
            </div>

            <!-- BOM Output -->
            <div id="bom-output" class="hidden mt-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Aggregated Bill of Materials (Shopping List)</h2>
                </div>
                <div id="bom-sections-container">
                    <!-- BOM will be generated here -->
                </div>
            </div>


            <!-- Margin and Final Total Section -->
            <div id="final-calculation-section" class="hidden mt-6 flex justify-end">
                <div class="w-full max-w-sm bg-gray-800 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Aggregated BOM Total</span>
                        <span id="bom-sub-total-display" class="font-semibold">₹ 0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <label for="margin-multiplier" class="text-gray-400">Margin Multiplier (x)</label>
                        <span id="margin-multiplier" contenteditable="true"
                            class="bg-gray-700 px-2 py-1 rounded font-semibold text-right w-20">2.20</span>
                    </div>
                    <hr class="border-gray-600 my-2">
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xl font-bold">Final Total</span>
                        <span id="final-total" class="text-xl font-bold text-green-400">₹ 0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FT_TO_MM = 304.8;
        const MM_TO_FT = 1 / 304.8;
        const SQMM_TO_SQFT = MM_TO_FT * MM_TO_FT;
        const MIN_PORTAL_THICKNESS_MM = 18;
        const BACK_PANEL_MODULE_MM = 600;
        const SHEET_SQFT = 32; // 8ft x 4ft

        // --- PARX RATE CONTRACT DATA ---
        const PARX_RATE_CONTRACT = {
            "SIDE PORTAL": [
                { l: 18, w: 450, h: 1800, finalRate: 2340, ecplRate: 2160 },
                { l: 18, w: 450, h: 2100, finalRate: 2340, ecplRate: 2520 },
                { l: 18, w: 450, h: 2400, finalRate: 2340, ecplRate: 2880 },
                { l: 18, w: 450, h: 2700, finalRate: 2750, ecplRate: 3240 },
                { l: 75, w: 450, h: 1800, finalRate: 6500, ecplRate: 6300 },
                { l: 75, w: 450, h: 2100, finalRate: 6500, ecplRate: 7350 },
                { l: 75, w: 450, h: 2400, finalRate: 6500, ecplRate: 8400 },
                { l: 75, w: 450, h: 2700, finalRate: 7680, ecplRate: 9450 },
                { l: 100, w: 450, h: 1800, finalRate: 6500, ecplRate: 6676 },
                { l: 100, w: 450, h: 2100, finalRate: 6500, ecplRate: 7770 },
                { l: 100, w: 450, h: 2400, finalRate: 6500, ecplRate: 8880 },
                { l: 100, w: 450, h: 2700, finalRate: 7000, ecplRate: 9990 },
                { l: 150, w: 450, h: 1800, finalRate: 6800, ecplRate: 6840 },
                { l: 150, w: 450, h: 2100, finalRate: 6800, ecplRate: 7980 },
                { l: 150, w: 450, h: 2400, finalRate: 6800, ecplRate: 9120 },
                { l: 150, w: 450, h: 2700, finalRate: 7500, ecplRate: 10530 },
                { l: 200, w: 450, h: 1800, finalRate: 7500, ecplRate: 7200 },
                { l: 200, w: 450, h: 2100, finalRate: 7500, ecplRate: 8400 },
                { l: 200, w: 450, h: 2400, finalRate: 7500, ecplRate: 9600 },
                { l: 200, w: 450, h: 2700, finalRate: 8000, ecplRate: 9600 },
                { l: 50, w: 450, h: 1800, finalRate: 2400, ecplRate: 4000 },
                { l: 50, w: 450, h: 2100, finalRate: 2400, ecplRate: 4000 },
                { l: 50, w: 450, h: 2400, finalRate: 2800, ecplRate: 4000 },
                { l: 50, w: 450, h: 2700, finalRate: 2800, ecplRate: 4000 },
            ],
            "BACK PANEL": [
                { l: 600, w: 18, h: 1800, finalRate: 3130, ecplRate: 3240 },
                { l: 600, w: 18, h: 2100, finalRate: 3130, ecplRate: 3780 },
                { l: 600, w: 18, h: 2400, finalRate: 3130, ecplRate: 4320 },
                { l: 600, w: 18, h: 2700, finalRate: 3680, ecplRate: 4860 },
            ],
            "SHELVE": [
                { l: 600, w: 430, h: 18, finalRate: 750, ecplRate: 950 },
                { l: 500, w: 430, h: 18, finalRate: 700, ecplRate: 800 },
            ],
            "DRAWER": [
                { l: 600, w: 430, h: 325, finalRate: 4500, ecplRate: 6489 },
                { l: 500, w: 430, h: 325, finalRate: 4500, ecplRate: 5295 },
            ],
            "HEADER": [
                { l: 1219, w: 450, h: 300, finalRate: 6500, ecplRate: 8010 },
                { l: 1396, w: 450, h: 300, finalRate: 7500, ecplRate: 12275 },
                { l: 1800, w: 450, h: 300, finalRate: 9500, ecplRate: 14508 },
                { l: 2100, w: 450, h: 300, finalRate: 12100, ecplRate: 22470 },
                { l: 2400, w: 450, h: 300, finalRate: 13500, ecplRate: 25680 },
                { l: 3000, w: 450, h: 300, finalRate: 17500, ecplRate: 3210 },
                { l: 4000, w: 450, h: 300, finalRate: 22500, ecplRate: 40280 },
                { l: 4500, w: 450, h: 300, finalRate: 25500, ecplRate: 45315 },
                { l: 5000, w: 450, h: 300, finalRate: 28500, ecplRate: 50350 },
                { l: 5000, w: 450, h: 300, finalRate: 31500, ecplRate: 55385 },
            ],
            "CHANNEL": [
                { l: 40, w: 25, h: 1800, finalRate: 850, ecplRate: 1440 },
                { l: 40, w: 25, h: 2100, finalRate: 850, ecplRate: 1470 },
                { l: 40, w: 25, h: 2400, finalRate: 850, ecplRate: 1550 },
            ],
            "PLINTH": [
                { l: 600, w: 50, h: 50, finalRate: 1000, ecplRate: 2150 },
                { l: 500, w: 50, h: 50, finalRate: 1000, ecplRate: 1791 },
            ],
            "STRAIGHT ARM": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 497 },
            ],
            "BACKBAR": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 597 },
            ],
            "SHELF BRACKET": [
                { l: 0, w: 0, h: 0, finalRate: 250, ecplRate: 380 },
            ],
        };

        function findClosestRate(itemKey, l, w, h, rateType) {
            const rateList = PARX_RATE_CONTRACT[itemKey.toUpperCase().replace(/S$/, '').replace(/_/, ' ')];
            if (!rateList) return { rate: 0, source: null };

            let closestMatch = null;
            let minDiff = Infinity;

            rateList.forEach(rateItem => {
                const diff = Math.abs(rateItem.l - l) + Math.abs(rateItem.w - w) + Math.abs(rateItem.h - h);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestMatch = rateItem;
                }
            });

            if (closestMatch) {
                return {
                    rate: closestMatch[rateType],
                    source: closestMatch
                };
            }
            return { rate: 0, source: null };
        }


        // --- BRAND-SPECIFIC FIXTURE CONFIGURATION ---
        const BRAND_DATA = {
            "Parx": {
                getRate: findClosestRate,
                wallFixtures: [
                    { item: "Header", unit: "Nos", rate: 0, qty: () => 1, l: (w, h, config) => w, w: () => 450, h: () => 300 },
                    { item: "Side Portals", unit: "Nos", rate: 0, qty: () => 2, l: (w, h, config) => config.adjustedPortalThickness, w: () => 450, h: (w, h) => h - 300 },
                    { item: "Back Panels", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 18, h: (w, h) => h - 300 },
                    { item: "Channels", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays + 1, l: () => 40, w: () => 25, h: (w, h) => h - 300 },
                    {
                        item: "Shelves", unit: "Nos", rate: 0, qty: (w, h, config) => {
                            const bottomClearance = 50 + 325; // plinth + drawer
                            const availableHeight = h - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 600, w: () => 430, h: () => 18
                    },
                    { item: "Drawers", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => 600, w: () => 430, h: () => 325 },
                    { item: "Plinth", unit: "Nos", rate: 0, qty: (w, h, config) => config.numBays, l: () => BACK_PANEL_MODULE_MM, w: () => 50, h: () => 50 },
                    { item: "Signage", unit: "SqFt", rate: 3650, qty: () => (600 * 300) * SQMM_TO_SQFT, l: () => 600, w: () => 30, h: () => 300 }
                ],
                accessories: [
                    { item: "Straight Arm", unit: "Nos", rate: 0, qty: () => 1, l: () => 25, w: () => 300, h: () => 25 },
                    { item: "Backbar", unit: "Nos", rate: 0, qty: () => 1, l: () => 580, w: () => 25, h: () => 25 },
                    {
                        item: "Shelf Bracket", unit: "Nos", rate: 0, qty: (w, h, config) => {
                            const bottomClearance = 50 + 325;
                            const availableHeight = h - 300 - bottomClearance - 300;
                            if (availableHeight < 0) return 0;
                            const numShelfLevels = Math.floor(availableHeight / 300) + 1;
                            return numShelfLevels * config.numBays;
                        }, l: () => 0, w: () => 0, h: () => 0
                    },
                ]
            },
            "Park Avenue": {}, // Simplified for brevity
            "ColorPlus": {},
            "Ethnix": {}
        };
        BRAND_DATA["Ready to Wear"] = BRAND_DATA["Parx"];
        BRAND_DATA["Park Avenue"] = BRAND_DATA["Parx"]; // temp for testing
        BRAND_DATA["ColorPlus"] = BRAND_DATA["Parx"];
        BRAND_DATA["Ethnix"] = BRAND_DATA["Parx"];


        const BOM_DATA = {
            "Parx": {
                materials: [
                    {
                        item: "18mm MDF OSL (Off-white)",
                        unit: "SqFt",
                        rate: 65,
                        wastage: 15,
                        sheetGood: true,
                        calculateBaseQty: (fixture) => {
                            let area = 0;
                            if (['Header', 'Side Portals', 'Plinth'].includes(fixture.item)) {
                                area = (2 * (fixture.l * fixture.w + fixture.l * fixture.h + fixture.w * fixture.h));
                            }
                            if (fixture.item === 'Drawers') {
                                area = (fixture.l * fixture.w) + (fixture.l * fixture.h);
                            }
                            return area * SQMM_TO_SQFT;
                        }
                    },
                    {
                        item: "18mm MDF BSL (Off-white)",
                        unit: "SqFt",
                        rate: 75,
                        wastage: 15,
                        sheetGood: true,
                        calculateBaseQty: (fixture) => {
                            let area = 0;
                            if (fixture.item === 'Back Panels') {
                                area = (fixture.l * fixture.h);
                            }
                            if (fixture.item === 'Drawers') {
                                area = (2 * fixture.w * fixture.h) + (fixture.l * fixture.h);
                            }
                            if (fixture.item === 'Shelves') {
                                area = (fixture.l * fixture.w);
                            }
                            return area * SQMM_TO_SQFT;
                        }
                    },
                    {
                        item: "25mm MDF BSL (for Duco Pattern)",
                        unit: "SqFt",
                        rate: 100,
                        wastage: 15,
                        sheetGood: true,
                        calculateBaseQty: (fixture) => {
                            if ((['Header', 'Side Portals'].includes(fixture.item)) && fixture.l >= 50) {
                                return (fixture.l * fixture.h) * SQMM_TO_SQFT;
                            }
                            return 0;
                        }
                    },
                    {
                        item: "Light Blue Laminate (1mm)",
                        unit: "SqFt",
                        rate: 47,
                        wastage: 15,
                        sheetGood: true,
                        calculateBaseQty: (fixture) => {
                            let area = 0;
                            if (['Header', 'Side Portals', 'Plinth'].includes(fixture.item)) {
                                area = (2 * (fixture.l * fixture.w + fixture.l * fixture.h + fixture.w * fixture.h));
                            }
                            if (fixture.item === 'Drawers') {
                                area = (fixture.l * fixture.w) + (fixture.l * fixture.h);
                            }
                            return area * SQMM_TO_SQFT;
                        }
                    },
                    {
                        item: "Duco Paint (for Pattern)", unit: "SqFt", rate: 200, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            if (!['Header', 'Side Portals'].includes(fixture.item) || fixture.l < 50) return 0;
                            return (fixture.l * fixture.h * 1.5) * SQMM_TO_SQFT;
                        }
                    },
                    {
                        item: "PVC Edge Banding (25mm)", unit: "RFt", rate: 7, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            if (['Header', 'Side Portals', 'Plinth', 'Shelves', 'Drawers'].includes(fixture.item)) {
                                return (2 * (fixture.l + fixture.w)) * MM_TO_FT;
                            }
                            return 0;
                        }
                    },
                    {
                        item: "Aluminium Channel Profile", unit: "RFt", rate: 115, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            return fixture.item === 'Channels' ? 8 : 0; // Each channel consumes an 8ft length
                        }
                    },
                    {
                        item: "Backclips for Accessories", unit: "Nos", rate: 40, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            return ['Straight Arm', 'Backbar'].includes(fixture.item) ? 2 : 0;
                        }
                    },
                    {
                        item: "MS Pipe (25x40mm, 1.5mm thk)", unit: "Kg", rate: 110, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            const weightPerFoot = 0.45;
                            if (fixture.item === 'Straight Arm') return (fixture.w * MM_TO_FT) * weightPerFoot;
                            if (fixture.item === 'Backbar') return (fixture.l * MM_TO_FT) * weightPerFoot;
                            return 0;
                        }
                    },
                    {
                        item: "Powder Coating", unit: "Lump Sum Cost", rate: 1, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            const rftRate = 25;
                            const sqftRate = 50;
                            if (fixture.item === 'Channels') {
                                return ((2 * (fixture.l + fixture.w) * fixture.h) * SQMM_TO_SQFT) * sqftRate;
                            }
                            if (fixture.item === 'Backbar') {
                                return (fixture.l * MM_TO_FT) * rftRate;
                            }
                            if (fixture.item === 'Shelf Bracket') {
                                return (350 * MM_TO_FT) * rftRate;
                            }
                            return 0;
                        }
                    },
                    {
                        item: "Finished 3D Acrylic Signage", unit: "SqFt", rate: 3650, wastage: 0,
                        calculateBaseQty: (fixture) => {
                            return fixture.item === 'Signage' ? (600 * 300) * SQMM_TO_SQFT : 0;
                        }
                    }
                ]
            }
        }


        // --- DOM ELEMENTS ---
        const form = document.getElementById('boq-form');
        const brandSelect = document.getElementById('brand-select');
        const rateTypeContainer = document.getElementById('rate-type-container');
        const rateTypeSelect = document.getElementById('rate-type-select');
        const widthInput = document.getElementById('wall-width');
        const heightInput = document.getElementById('wall-height');
        const errorMessage = document.getElementById('error-message');
        const boqOutput = document.getElementById('boq-output');
        const boqTitle = document.getElementById('boq-title');
        const sectionsContainer = document.getElementById('boq-sections-container');
        const grandTotalCell = document.getElementById('grand-total');
        const printBtn = document.getElementById('print-btn');
        const bomOutput = document.getElementById('bom-output');
        const bomContainer = document.getElementById('bom-sections-container');
        const itemWiseBomOutput = document.getElementById('item-wise-bom-output');
        const itemWiseBomContainer = document.getElementById('item-wise-bom-container');
        const finalCalculationSection = document.getElementById('final-calculation-section');
        const bomSubTotalDisplay = document.getElementById('bom-sub-total-display');
        const marginMultiplier = document.getElementById('margin-multiplier');
        const finalTotalCell = document.getElementById('final-total');


        // --- EVENT LISTENERS ---
        form.addEventListener('submit', handleFormSubmit);
        printBtn.addEventListener('click', () => window.print());
        sectionsContainer.addEventListener('input', handleBoqCellChange);
        itemWiseBomContainer.addEventListener('input', handleItemWiseBomCellChange);
        marginMultiplier.addEventListener('input', recalculateAll);
        brandSelect.addEventListener('change', toggleRateTypeSelector);

        // --- FUNCTIONS ---
        function toggleRateTypeSelector() {
            if (brandSelect.value === 'Parx' || brandSelect.value === 'Ready to Wear') {
                rateTypeContainer.classList.remove('hidden');
            } else {
                rateTypeContainer.classList.add('hidden');
            }
        }
        toggleRateTypeSelector(); // Initial check

        function calculateWallConfig(wallWidthInMM) {
            const internalSpaceGuess = wallWidthInMM - (2 * MIN_PORTAL_THICKNESS_MM);
            let numBays = Math.round(internalSpaceGuess / BACK_PANEL_MODULE_MM);
            if (numBays < 1) numBays = 1;

            const totalModuleWidth = numBays * BACK_PANEL_MODULE_MM;
            const remainingWidthForPortals = wallWidthInMM - totalModuleWidth;
            let adjustedPortalThickness = remainingWidthForPortals / 2;

            if (adjustedPortalThickness < MIN_PORTAL_THICKNESS_MM) {
                if (numBays > 1) {
                    numBays--;
                    const newTotalModuleWidth = numBays * BACK_PANEL_MODULE_MM;
                    const newRemainingWidth = wallWidthInMM - newTotalModuleWidth;
                    adjustedPortalThickness = newRemainingWidth / 2;
                }
            }

            return { numBays, adjustedPortalThickness };
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const width = parseFloat(widthInput.value);
            const height = parseFloat(heightInput.value);
            const brand = brandSelect.value;

            if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                errorMessage.textContent = 'Please enter valid, positive numbers for dimensions.';
                boqOutput.classList.add('hidden');
                return;
            }
            errorMessage.textContent = '';
            fullCalculationFlow(width, height, brand);
        }

        function fullCalculationFlow(width, height, brand) {
            const data = BRAND_DATA[brand];
            if (!data) return;

            // Clear all outputs
            sectionsContainer.innerHTML = '';
            itemWiseBomContainer.innerHTML = '';
            bomContainer.innerHTML = '';
            [boqOutput, itemWiseBomOutput, bomOutput, finalCalculationSection].forEach(el => el.classList.add('hidden'));

            // Step 1: Generate BOQ
            boqTitle.textContent = `BOQ for ${brand} Wall (${width}mm x ${height}mm)`;
            const wallConfig = calculateWallConfig(width);

            const sectionMappings = { 'Wall Fixtures': data.wallFixtures, 'Accessories': data.accessories };
            const rateType = rateTypeSelect.value;

            for (const [title, items] of Object.entries(sectionMappings)) {
                if (items && items.length > 0) {
                    const sectionHTML = createSectionHTML(title, items, width, height, wallConfig, data.getRate, rateType, brand);
                    if (sectionHTML) sectionsContainer.insertAdjacentHTML('beforeend', sectionHTML);
                }
            }
            boqOutput.classList.remove('hidden');

            // Step 2: Generate Item-wise BOM from BOQ
            recalculateAll();
        }

        function createSectionHTML(title, items, width, height, wallConfig, getRateFn, rateType, brand) {
            let rowsHTML = '';

            items.forEach(item => {
                const qty = item.qty(width, height, wallConfig);
                if (qty <= 0) return;

                const l = item.l(width, height, wallConfig);
                const w = item.w(width, height, wallConfig);
                const h = item.h(width, height, wallConfig);

                let rate = item.rate;
                let sourceDimText = 'N/A';

                if (getRateFn) {
                    const itemKey = item.item.replace(/\s+/g, '_');
                    const result = getRateFn(itemKey, l, w, h, rateType);
                    if (result && result.source) {
                        rate = result.rate;
                        sourceDimText = (result.source.l === 0 && result.source.w === 0 && result.source.h === 0)
                            ? 'Standard' : `${result.source.l}x${result.source.w}x${result.source.h}`;
                    }
                }

                rowsHTML += `
                <tr class="border-b border-gray-700" data-item-key="${item.item.replace(/\s+/g, '_')}">
                    <td class="p-3" data-label="item">${item.item}</td>
                    <td class="p-3 text-gray-400">${sourceDimText}</td>
                    <td class="p-3 text-right" data-label="l">${Math.round(l)}</td>
                    <td class="p-3 text-right" data-label="w">${Math.round(w)}</td>
                    <td class="p-3 text-right" data-label="h">${Math.round(h)}</td>
                    <td class="p-3 text-right" contenteditable="true" data-qty>${qty.toFixed(2)}</td>
                    <td class="p-3">${item.unit}</td>
                    <td class="p-3 text-right" contenteditable="true" data-rate>${rate.toFixed(2)}</td>
                    <td class="p-3 text-right font-medium" data-amount>0.00</td>
                </tr>
            `;
            });

            if (!rowsHTML) return '';

            return `
            <div class="boq-section mb-8">
                <h3 class="text-xl font-bold bg-gray-700 p-3 rounded-t-lg">${title}</h3>
                <div class="overflow-x-auto bg-gray-800 rounded-b-lg">
                    <table class="boq-table">
                         <colgroup>
                           <col class="item"><col class="source"><col class="l"><col class="w"><col class="h"><col class="qty"><col class="unit"><col class="rate"><col class="amount">
                        </colgroup>
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="p-3 text-left font-semibold">Item</th>
                                <th class="p-3 text-left font-semibold">Source Dim.</th>
                                <th class="p-3 text-right font-semibold">L(mm)</th>
                                <th class="p-3 text-right font-semibold">W(mm)</th>
                                <th class="p-3 text-right font-semibold">H(mm)</th>
                                <th class="p-3 text-right font-semibold">Quantity</th>
                                <th class="p-3 text-left font-semibold">Unit</th>
                                <th class="p-3 text-right font-semibold">Rate (₹)</th>
                                <th class="p-3 text-right font-semibold">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHTML}</tbody>
                    </table>
                </div>
            </div>
        `;
        }

        function generateAndDisplayItemWiseBOM(brand, fixtures) {
            itemWiseBomContainer.innerHTML = '';
            const bomData = BOM_DATA[brand];
            if (!bomData) return;

            let allTablesHTML = '';
            const uniqueFixtures = Object.values(fixtures).map(arr => arr[0]); // Get one of each fixture type

            uniqueFixtures.forEach(fixture => {
                let rowsHTML = '';

                bomData.materials.forEach(mat => {
                    const baseQty = mat.calculateBaseQty(fixture);
                    if (baseQty > 0) {
                        rowsHTML += `
                        <tr class="border-b border-gray-700" data-mat-item="${mat.item}">
                            <td class="p-2">${mat.item}</td>
                            <td class="p-2 text-right" data-base-qty>${baseQty.toFixed(2)}</td>
                            <td class="p-2 text-center">${mat.unit}</td>
                            <td class="p-2 text-right" contenteditable="true" data-wastage>${mat.wastage.toFixed(2)}</td>
                            <td class="p-2 text-right" data-final-qty>0.00</td>
                            <td class="p-2 text-right">${mat.rate.toFixed(2)}</td>
                            <td class="p-2 text-right font-medium" data-mat-amount>₹ 0.00</td>
                        </tr>
                    `;
                    }
                });

                if (rowsHTML) {
                    const dims = `(${Math.round(fixture.l)}L x ${Math.round(fixture.w)}W x ${Math.round(fixture.h)}H mm)`;
                    allTablesHTML += `
                    <div class="boq-section mb-8" data-item-key="${fixture.item.replace(/\s+/g, '_')}">
                        <h3 class="text-lg font-bold bg-gray-700 p-3 rounded-t-lg">${fixture.item} <span class="text-sm font-normal text-gray-300">${dims}</span></h3>
                        <div class="overflow-x-auto bg-gray-800 rounded-b-lg">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="p-2 text-left font-semibold w-2/5">Material</th>
                                        <th class="p-2 text-right font-semibold">Base Qty</th>
                                        <th class="p-2 text-center font-semibold">Unit</th>
                                        <th class="p-2 text-right font-semibold">Wastage %</th>
                                        <th class="p-2 text-right font-semibold">Final Qty</th>
                                        <th class="p-2 text-right font-semibold">Rate (₹)</th>
                                        <th class="p-2 text-right font-semibold">Amount (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>${rowsHTML}</tbody>
                                <tfoot>
                                    <tr class="border-t-2 border-gray-600 bg-gray-700/50">
                                        <td colspan="6" class="p-2 text-right font-bold">Total Material Cost per Item</td>
                                        <td class="p-2 text-right font-bold" data-item-rmc-total>₹ 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                }
            });

            if (allTablesHTML) {
                itemWiseBomContainer.innerHTML = allTablesHTML;
                itemWiseBomOutput.classList.remove('hidden');
            }
        }

        function generateAndDisplayAggregatedBOM(brand, fixtures, itemWiseRmcData) {
            bomContainer.innerHTML = '';
            const bomData = BOM_DATA[brand];
            if (!bomData) return;

            const materialTotals = {};

            // Aggregate materials from itemWiseRmcData
            for (const fixtureKey in fixtures) {
                const fixtureArray = fixtures[fixtureKey];
                if (fixtureArray.length > 0) {
                    const boqQty = fixtureArray.reduce((sum, f) => sum + f.qty, 0);
                    const itemRmc = itemWiseRmcData[fixtureKey];
                    if (itemRmc) {
                        for (const matItem in itemRmc.materials) {
                            const matData = itemRmc.materials[matItem];
                            if (!materialTotals[matItem]) {
                                const masterMatData = bomData.materials.find(m => m.item === matItem);
                                materialTotals[matItem] = { totalQty: 0, ...masterMatData };
                            }
                            materialTotals[matItem].totalQty += matData.finalQty * boqQty;
                        }
                    }
                }
            }

            let rowsHTML = '';
            for (const matItem in materialTotals) {
                const mat = materialTotals[matItem];
                let displayQty = mat.totalQty;
                let displayUnit = mat.unit;
                let rateForTotal = mat.rate;

                if (mat.sheetGood) {
                    displayQty = Math.ceil(mat.totalQty / SHEET_SQFT);
                    displayUnit = `Sheets (8x4 ft)`;
                    // Rate is per sqft, but total is per sheet. Adjust rate for total calculation.
                    rateForTotal = mat.rate * SHEET_SQFT;
                }

                const amount = displayQty * rateForTotal;
                rowsHTML += `
                 <tr class="border-b border-gray-700">
                    <td class="p-3">${mat.item}</td>
                    <td class="p-3 text-right">${displayQty.toFixed(2)}</td>
                    <td class="p-3 text-center">${displayUnit}</td>
                    <td class="p-3 text-right">${mat.rate.toFixed(2)}</td>
                    <td class="p-3 text-right font-medium" data-bom-amount>₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `;
            }


            if (rowsHTML) {
                const tableHTML = `
                <div class="boq-section mb-8">
                    <div class="overflow-x-auto bg-gray-800 rounded-lg">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="p-3 text-left font-semibold w-2/5">Item</th>
                                    <th class="p-3 text-right font-semibold">Total Qty</th>
                                    <th class="p-3 text-center font-semibold">Unit</th>
                                    <th class="p-3 text-right font-semibold">Rate (₹)</th>
                                    <th class="p-3 text-right font-semibold">Amount (₹)</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHTML}</tbody>
                            <tfoot>
                                <tr class="border-t-2 border-gray-600 bg-gray-700">
                                    <td colspan="4" class="p-3 text-right font-bold">Aggregated BOM Total</td>
                                    <td id="bom-sub-total-cell" class="p-3 text-right font-bold">₹ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
                bomContainer.innerHTML = tableHTML;
                [bomOutput, finalCalculationSection].forEach(el => el.classList.remove('hidden'));
            }
        }


        function recalculateAll() {
            // Recalculate Item-Wise BOM and get its data
            const brand = brandSelect.value;
            const fixtures = getFixturesFromBOQTable();
            generateAndDisplayItemWiseBOM(brand, fixtures);

            const itemWiseRmcData = {};

            itemWiseBomContainer.querySelectorAll('.boq-section').forEach(table => {
                const itemKey = table.dataset.itemKey;
                let itemTotalRmc = 0;
                const materials = {};

                table.querySelectorAll('tbody tr').forEach(row => {
                    const matItem = row.dataset.matItem;
                    const baseQty = parseFloat(row.querySelector('[data-base-qty]').textContent) || 0;
                    const wastage = parseFloat(row.querySelector('[data-wastage]').textContent) || 0;
                    const rate = parseFloat(row.querySelector('td:nth-last-child(2)').textContent) || 0;

                    const finalQty = baseQty * (1 + wastage / 100);
                    const amount = finalQty * rate;
                    itemTotalRmc += amount;

                    materials[matItem] = { finalQty, amount };

                    row.querySelector('[data-final-qty]').textContent = finalQty.toFixed(2);
                    row.querySelector('[data-mat-amount]').textContent = `₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                });
                table.querySelector('[data-item-rmc-total]').textContent = `₹ ${itemTotalRmc.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                itemWiseRmcData[itemKey] = { total: itemTotalRmc, materials };
            });

            // Update BOQ with new RMC values
            sectionsContainer.querySelectorAll('tbody tr').forEach(boqRow => {
                const itemKey = boqRow.dataset.itemKey;
                const rmcData = itemWiseRmcData[itemKey];

                const qty = parseFloat(boqRow.querySelector('[data-qty]').textContent) || 0;
                const rate = parseFloat(boqRow.querySelector('[data-rate]').textContent) || 0;

                boqRow.querySelector('[data-amount]').textContent = `₹ ${(rate * qty).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            });

            // Recalculate Aggregated BOM using the data we just gathered
            const updatedFixtures = getFixturesFromBOQTable();
            generateAndDisplayAggregatedBOM(brand, updatedFixtures, itemWiseRmcData);

            // Update All Totals
            updateTotals();
            updateBomTotal();
        }

        function handleBoqCellChange(event) {
            const target = event.target;
            if (target.hasAttribute('data-rate') || target.hasAttribute('data-qty')) {
                recalculateAll();
            }
        }

        function handleItemWiseBomCellChange(event) {
            if (event.target.matches('[data-wastage]')) {
                recalculateAll();
            }
        }

        function getFixturesFromBOQTable() {
            const fixtures = {};
            sectionsContainer.querySelectorAll('tbody tr').forEach(row => {
                const itemKey = row.dataset.itemKey;
                if (!itemKey) return;

                if (!fixtures[itemKey]) fixtures[itemKey] = [];

                fixtures[itemKey].push({
                    item: row.querySelector('[data-label="item"]').textContent,
                    l: parseFloat(row.querySelector('[data-label="l"]').textContent) || 0,
                    w: parseFloat(row.querySelector('[data-label="w"]').textContent) || 0,
                    h: parseFloat(row.querySelector('[data-label="h"]').textContent) || 0,
                    qty: parseFloat(row.querySelector('[data-qty]').textContent) || 0,
                });
            });
            return fixtures;
        }


        function updateTotals() {
            let grandTotal = 0;
            sectionsContainer.querySelectorAll('tbody [data-amount]').forEach(cell => grandTotal += parseFloat(cell.textContent.replace(/[₹,]/g, '')) || 0);
            grandTotalCell.textContent = `₹ ${grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function updateBomTotal() {
            let bomTotal = 0;
            bomContainer.querySelectorAll('[data-bom-amount]').forEach(cell => bomTotal += parseFloat(cell.textContent.replace(/[₹,]/g, '')) || 0);

            const formattedTotal = `₹ ${bomTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const subTotalCell = bomContainer.querySelector('#bom-sub-total-cell');
            if (subTotalCell) subTotalCell.textContent = formattedTotal;

            bomSubTotalDisplay.textContent = formattedTotal;
            updateFinalTotal();
        }

        function updateFinalTotal() {
            const bomSubTotal = parseFloat(bomSubTotalDisplay.textContent.replace(/[₹,]/g, '')) || 0;
            const multiplier = parseFloat(marginMultiplier.textContent) || 0;
            const finalTotal = bomSubTotal * multiplier;
            finalTotalCell.textContent = `₹ ${finalTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    </script>
</body>

</html>